<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Analysis Tool • KIMHUBFX</title>

<link rel="stylesheet" href="style.css">

<style>
body { background:#f2f2f2; margin:0; font-family:Arial }

/* CARD */
.card {
  background:#fff;
  padding:20px;
  margin:15px;
  border-radius:12px;
  box-shadow:0 2px 5px rgba(0,0,0,0.15);
}

/* DIGIT GRID */
.digitItem { text-align:center; margin:8px }
.digitCircle {
  width:55px;height:55px;border-radius:50%;
  background:#111;color:#fff;display:flex;
  justify-content:center;align-items:center;
  font-size:22px;font-weight:bold;
}
.digitPercent { margin-top:4px;color:#00c853;font-weight:bold }

/* STREAM */
.stream { color:#000;font-weight:bold;font-size:18px }

/* HEATMAP */
#heatmap div { width:20px;background:#ff4d4d;border-radius:4px }

/* EVEN ODD BAR */
#evenFill,#oddFill {
  height:12px;border-radius:10px;
}
#evenFill { background:#16a34a }
#oddFill { background:#ef4444 }
</style>
</head>

<body>

<!-- SIDEBAR -->
<div id="sidebar" class="sidebar">
  <div class="side-inner">
    <h2>KIMHUBFX</h2>

    <div class="section-title">Channels</div>
    <a href="https://wa.me/254724753475" target="_blank">WhatsApp</a>
    <a href="https://t.me/kimhubfx" target="_blank">Telegram</a>
    <a href="https://www.instagram.com/kimh.tai" target="_blank">Instagram</a>
    <a href="https://www.youtube.com/@kimhtai" target="_blank">YouTube</a>
    <a href="https://www.facebook.com/profile.php?id=61582999149557" target="_blank">Facebook</a>
  </div>
</div>

<!-- TOP BAR -->
<header class="topbar">
  <div class="left">
    <button class="icon-btn" onclick="appUI.openMenu()">☰</button>
    <span class="logo">KIMHUBFX</span>
  </div>
</header>

<!-- HORIZONTAL MENU -->
<nav class="horizontal-menu">
  <div onclick="location.href='dashboard.html'">Dashboard</div>
  <div onclick="location.href='bot-builder.html'">Bot Builder</div>
  <div onclick="location.href='freebots.html'">FreeBots</div>
  <div class="menu-item active">Analysis Tool</div>
  <div onclick="location.href='dp-tool.html'">DP Tool</div>
</nav>

<main class="container">

<!-- CONTROLS -->
<div class="card">
  <label>Market:</label>
  <select id="marketSelect">
    <option value="R_100" selected>Volatility 100</option>
    <option value="R_75">Volatility 75</option>
    <option value="R_50">Volatility 50</option>
    <option value="R_25">Volatility 25</option>
    <option value="R_10">Volatility 10</option>
  </select>

  <label style="margin-left:10px">History:</label>
  <input id="historySize" type="number" value="500" min="50" max="5000">

  <button id="connectBtn" class="btn">Connect</button>
  <button id="disconnectBtn" class="btn secondary">Disconnect</button>
  <button id="pauseBtn" class="btn secondary">Pause</button>

  <div style="float:right;text-align:right;">
    <div style="font-weight:bold">Connection:</div>
    <div id="connStatus">Disconnected</div>
  </div>
</div>

<!-- PRICE PANEL -->
<div class="card">
  <div style="display:flex;justify-content:space-between;">
    <div>
      <div style="font-size:14px;color:#666">Live Price</div>
      <div id="latestPrice" style="font-size:28px;font-weight:900;color:#111">—</div>
      <div id="latestTime" style="color:#888;font-size:13px">—</div>
    </div>

    <div style="text-align:center">
      <div style="font-size:14px;color:#666">Last Digit</div>
      <div id="lastDigit" style="font-size:40px;font-weight:900;color:#ff4d4d">—</div>
    </div>

    <div style="text-align:right">
      <div style="font-size:14px;color:#666">Total ticks</div>
      <div id="totalTicks" style="font-weight:900">0</div>
    </div>
  </div>

  <hr>

  <!-- DIGIT GRID -->
  <div id="digitGrid" style="display:flex;flex-wrap:wrap;justify-content:center"></div>

  <!-- DIGIT STREAM -->
  <div id="digitStream" class="stream" style="margin-top:10px">—</div>
</div>

<!-- HEATMAP + EVEN/ODD -->
<div class="card" style="display:flex;gap:20px;flex-wrap:wrap">

  <div style="flex:1">
    <h3>Heatmap</h3>
    <div id="heatmap" style="display:flex;align-items:flex-end;gap:5px;height:120px"></div>

    <h3 style="margin-top:20px">Even / Odd</h3>

    <div style="display:flex;align-items:center;margin-top:10px">
      <div style="width:60px">Even</div>
      <div style="flex:1;background:#eee;border-radius:10px;overflow:hidden">
        <div id="evenFill" style="width:0%"></div>
      </div>
      <div id="evenPct" style="width:60px;text-align:right;font-weight:bold">0%</div>
    </div>

    <div style="display:flex;align-items:center;margin-top:10px">
      <div style="width:60px">Odd</div>
      <div style="flex:1;background:#eee;border-radius:10px;overflow:hidden">
        <div id="oddFill" style="width:0%"></div>
      </div>
      <div id="oddPct" style="width:60px;text-align:right;font-weight:bold">0%</div>
    </div>
  </div>

  <div style="flex:1">
    <h3>Predictions</h3>
    <div id="freqPred"></div>
    <div id="markovPred" style="margin-top:10px"></div>
    <button id="refreshPred" class="btn" style="margin-top:10px">Refresh</button>

    <h3 style="margin-top:20px">Trending</h3>
    <div>Top digit: <b id="topDigit">—</b></div>
    <div>Streak: <b id="streakCount">0</b></div>
    <div id="recentDigits" style="margin-top:10px"></div>
  </div>

</div>

<!-- DISTRIBUTION -->
<div class="card">
  <h3>Distribution Table</h3>
  <table style="width:100%;border-collapse:collapse">
    <thead><tr>
      <th>Digit</th><th>Count</th><th>%</th><th>Bar</th>
    </tr></thead>
    <tbody id="distributionTable"></tbody>
  </table>
</div>

</main>

<!-- PART 3 ENGINE -->
<script>
let digits = [];
let maxHistory = 500;
let paused = false;
let latestDigit = null;
let lastPrice = null;
let lastTickTime = null;

document.addEventListener("DOMContentLoaded", () => {
  maxHistory = parseInt(document.getElementById("historySize").value);
});

function addTick(price, epoch){
  if(paused) return;

  lastPrice = price;
  lastTickTime = new Date(epoch*1000).toLocaleTimeString();

  const d = parseInt(price.toString().slice(-1));
  latestDigit = d;

  digits.push(d);
  if(digits.length > maxHistory) digits.shift();

  updateUI();
}

function updateUI(){
  updatePriceBox();
  updateDigitGrid();
  updateDigitStream();
  updateHeatmap();
  updateEvenOdd();
  updateDistributionTable();
  updateTrending();
  updatePredictions();
}

function updatePriceBox(){
  latestPrice.textContent = lastPrice ?? "—";
  latestTime.textContent = lastTickTime ?? "—";
  lastDigit.textContent = latestDigit ?? "—";
  totalTicks.textContent = digits.length;
}

function updateDigitGrid(){
  const g = document.getElementById("digitGrid");
  g.innerHTML = "";
  const c = getCounts();
  const tot = digits.length || 1;

  for(let d=0; d<=9; d++){
    const pct = (c[d]/tot*100).toFixed(2);
    g.innerHTML += `
      <div class="digitItem">
        <div class="digitCircle">${d}</div>
        <div class="digitPercent">${pct}%</div>
      </div>`;
  }
}

function updateDigitStream(){
  digitStream.textContent = digits.slice(-40).join(" ");
}

function updateHeatmap(){
  const h = document.getElementById("heatmap");
  h.innerHTML = "";
  const c = getCounts();
  const max = Math.max(...Object.values(c)) || 1;

  for(let d=0; d<=9; d++){
    const ht = (c[d]/max)*100;
    h.innerHTML += `<div style="height:${ht}px"></div>`;
  }
}

function updateEvenOdd(){
  const tot = digits.length || 1;
  const ev = digits.filter(x=>x%2===0).length;
  const od = tot-ev;

  const ep = (ev/tot*100).toFixed(2);
  const op = (od/tot*100).toFixed(2);

  evenFill.style.width = ep+"%";
  oddFill.style.width = op+"%";

  evenPct.textContent = ep+"%";
  oddPct.textContent = op+"%";
}

function updateDistributionTable(){
  const tb = distributionTable;
  tb.innerHTML = "";
  const c = getCounts();
  const tot = digits.length || 1;

  for(let d=0; d<=9; d++){
    const pct = (c[d]/tot*100).toFixed(2);
    tb.innerHTML += `
    <tr>
      <td>${d}</td>
      <td>${c[d]}</td>
      <td>${pct}%</td>
      <td>
        <div style="background:#eee;height:10px;border-radius:10px">
          <div style="height:10px;width:${pct}%;background:#00c853;border-radius:10px"></div>
        </div>
      </td>
    </tr>`;
  }
}

function updateTrending(){
  if(digits.length===0) return;

  const c = getCounts();
  let top = 0;
  for(let i=1;i<=9;i++){
    if(c[i] > c[top]) top=i;
  }
  topDigit.textContent = top;

  let last = digits[digits.length-1];
  let st = 1;
  for(let i=digits.length-2;i>=0;i--){
    if(digits[i]===last) st++;
    else break;
  }
  streakCount.textContent = st;

  recentDigits.textContent = digits.slice(-20).join(" ");
}

function updatePredictions(){
  if(digits.length<20) return;

  const c = getCounts();
  let lowest = 0;
  for(let i=1;i<=9;i++){
    if(c[i]<c[lowest]) lowest=i;
  }
  freqPred.innerHTML = `Frequency Prediction: <b>${lowest}</b>`;

  const mk = buildMarkov();
  const last = digits[digits.length-1];
  const row = mk[last] || Array(10).fill(0);
  const bestNext = row.indexOf(Math.max(...row));

  markovPred.innerHTML = `Markov Prediction: <b>${bestNext}</b>`;
}

function getCounts(){
  let m={}; for(let i=0;i<10;i++) m[i]=0;
  digits.forEach(d=>m[d]++);
  return m;
}

function buildMarkov(){
  const m=[];
  for(let i=0;i<10;i++) m[i]=Array(10).fill(0);
  for(let i=0;i<digits.length-1;i++){
    const a=digits[i], b=digits[i+1];
    m[a][b]++;
  }
  return m;
}
</script>

<!-- PART 4 — WEBSOCKET -->
<script>
(function(){
  const APP_ID=1089;
  let ws=null;
  let paused=false;
  let reconnect=null;
  let delay=700;

  const statusBox=document.getElementById("connStatus");

  function connect(){
    disconnect();
    reset();
    statusBox.textContent="Connecting…";

    ws=new WebSocket("wss://ws.derivws.com/websockets/v3?app_id="+APP_ID);

    ws.onopen=()=>{
      delay=700;
      statusBox.textContent="Connected";
      subscribe();
    };

    ws.onmessage=(m)=>{
      const data=JSON.parse(m.data);
      if(data.tick){
        const quote=data.tick.quote;
        const epoch=data.tick.epoch;
        addTick(quote,epoch);
        statusBox.textContent="Live";
      }
    };

    ws.onerror=()=>{ statusBox.textContent="Error"; };
    ws.onclose=()=> scheduleReconnect();
  }

  function reset(){
    digits=[];
    updateUI();
  }

  function subscribe(){
    const mk=document.getElementById("marketSelect").value;
    ws.send(JSON.stringify({ticks:mk,subscribe:1}));
  }

  function scheduleReconnect(){
    if(reconnect) return;
    statusBox.textContent="Reconnecting…";
    reconnect=setTimeout(()=>{
      reconnect=null;
      delay=Math.min(8000,delay*1.4);
      connect();
    },delay);
  }

  function disconnect(){
    if(reconnect){clearTimeout(reconnect);reconnect=null;}
    if(ws){ws.close(1000,"ok");ws=null;}
    statusBox.textContent="Disconnected";
  }

  document.getElementById("connectBtn").onclick=connect;
  document.getElementById("disconnectBtn").onclick=disconnect;
  document.getElementById("pauseBtn").onclick=()=>{
    paused=!paused;
    document.getElementById("pauseBtn").textContent=paused?"Resume":"Pause";
  };

  document.getElementById("marketSelect").onchange=()=>{
    disconnect();
    setTimeout(connect,300);
  };

})();
</script>

</body>
</html>